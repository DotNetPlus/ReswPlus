using _ReswPlus_AutoGenerated.Utils;
using System.Globalization;
using System;

namespace _ReswPlus_AutoGenerated.Plurals
{
    internal static class ResourceLoaderExtension
    {
        private static _ReswPlus_AutoGenerated.Plurals.IPluralProvider _pluralProvider;
        private static readonly object _objLock = new object();

        public static string GetPlural(this _ReswPlus_AutoGenerated.ResourceStringProvider resourceStringProvider, string key, double number, bool supportNoneState = false)
        {
            if (supportNoneState && number == 0)
            {
                return resourceStringProvider.GetString(key + "_None");
            }

            if (_pluralProvider is null)
            {
                CreatePluralProvider();
                if (_pluralProvider == null)
                {
                    return "";
                }
            }
            string selectedSentence = null;
            var pluralType = _pluralProvider.ComputePlural(number);
            try
            {
                switch (pluralType)
                {
                    case PluralTypeEnum.ZERO:
                        selectedSentence = resourceStringProvider.GetString(key + "_Zero");
                        break;
                    case PluralTypeEnum.ONE:
                        selectedSentence = resourceStringProvider.GetString(key + "_One");
                        break;
                    case PluralTypeEnum.OTHER:
                        selectedSentence = resourceStringProvider.GetString(key + "_Other");
                        break;
                    case PluralTypeEnum.TWO:
                        selectedSentence = resourceStringProvider.GetString(key + "_Two");
                        break;
                    case PluralTypeEnum.FEW:
                        selectedSentence = resourceStringProvider.GetString(key + "_Few");
                        break;
                    case PluralTypeEnum.MANY:
                        selectedSentence = resourceStringProvider.GetString(key + "_Many");
                        break;
                }
            }
            catch { }
            return selectedSentence ?? "";
        }

        private static void CreatePluralProvider(string forcedCultureName = null)
        {
            lock (_objLock)
            {
                if (_pluralProvider is null)
                {
                    var cultureToUse = CultureInfo.CurrentUICulture.TwoLetterISOLanguageName;
                    if (!string.IsNullOrEmpty(forcedCultureName))
                    {
                        try
                        {
                            var forcedCulture = new CultureInfo(forcedCultureName)?.TwoLetterISOLanguageName;
                            if (!string.IsNullOrEmpty(forcedCulture))
                            {
                                cultureToUse = forcedCulture;
                            }
                        }
                        catch
                        {
                        }
                    }
                    _pluralProvider = GetPluralChooser(cultureToUse);
                }
            }
        }

        private static _ReswPlus_AutoGenerated.Plurals.IPluralProvider GetPluralChooser(string culture)
        {
            switch (culture)
            {
{{PluralProviderSelector}}
            }
        }
    }
}
